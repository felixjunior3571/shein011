# SuperPay Integration API

Sistema completo de integra√ß√£o com SuperPayBR v4 usando Node.js, Express e Supabase.

## üöÄ Caracter√≠sticas

- ‚úÖ **Webhook-based** - Sem polling, respeita rate limiting
- ‚úÖ **Tokens seguros** - Expira√ß√£o de 15 minutos
- ‚úÖ **Status completos** - Todos os c√≥digos da SuperPay
- ‚úÖ **Pronto para produ√ß√£o** - Error handling completo
- ‚úÖ **Supabase** - Banco PostgreSQL gerenciado

## üìã Endpoints

### POST /checkout
Cria uma fatura PIX e retorna QR Code + c√≥digo copia/cola.

**Body:**
\`\`\`json
{
  "amount": 27.97,
  "description": "Frete PAC - Cart√£o SHEIN",
  "payer": {
    "name": "Jo√£o Silva",
    "document": "12345678901",
    "email": "joao@email.com"
  }
}
\`\`\`

**Response:**
\`\`\`json
{
  "success": true,
  "data": {
    "external_id": "FRETE_1703123456789_abc123",
    "token": "a1b2c3d4e5f6...",
    "amount": 27.97,
    "pix_code": "00020126580014br.gov.bcb.pix...",
    "qr_code_base64": "iVBORw0KGgoAAAANSUhEUgAA...",
    "expires_at": "2023-12-21T10:30:00.000Z",
    "status": "pendente"
  }
}
\`\`\`

### POST /webhook/superpay
Recebe atualiza√ß√µes de status da SuperPay.

**Body (enviado pela SuperPay):**
\`\`\`json
{
  "external_id": "FRETE_1703123456789_abc123",
  "status": 5,
  "invoice_id": "inv_123456"
}
\`\`\`

### GET /verifica-status?token=...
Verifica status do pagamento via token.

**Response:**
\`\`\`json
{
  "success": true,
  "paid": true,
  "status": "pago",
  "message": "Pagamento confirmado!",
  "description": "Seu pagamento foi aprovado com sucesso",
  "action": "redirect_success",
  "data": {
    "external_id": "FRETE_1703123456789_abc123",
    "amount": 27.97,
    "status": "pago",
    "paid_at": "2023-12-21T10:15:30.000Z"
  }
}
\`\`\`

## üîß Configura√ß√£o

### 1. Vari√°veis de Ambiente

Copie `.env.example` para `.env` e configure:

\`\`\`env
# SuperPay
SUPERPAY_TOKEN=seu_token_aqui
SUPERPAY_SECRET=sua_chave_secreta_aqui
SUPERPAY_BASE_URL=https://api.superpaybr.com

# Supabase
SUPABASE_URL=https://seu-projeto.supabase.co
SUPABASE_KEY=sua_service_role_key_aqui

# Server
PORT=3000
ALLOWED_ORIGINS=https://seusite.com
WEBHOOK_BASE_URL=https://sua-api.vercel.app
\`\`\`

### 2. Banco de Dados

Execute o SQL no Supabase:

\`\`\`bash
# No painel do Supabase, v√° em SQL Editor e execute:
cat scripts/create-payments-table.sql
\`\`\`

### 3. Instala√ß√£o

\`\`\`bash
npm install
npm start
\`\`\`

## üìä Status Codes

| C√≥digo | Status Interno | Descri√ß√£o |
|--------|---------------|-----------|
| 1 | aguardando | Aguardando pagamento |
| 2 | processando | Processando |
| 3 | aguardando | Aguardando confirma√ß√£o |
| 4 | processando | Em an√°lise |
| 5 | **pago** | Pago/Aprovado ‚úÖ |
| 6 | recusado | Recusado ‚ùå |
| 7 | cancelado | Cancelado ‚ùå |
| 8 | estornado | Estornado ‚ùå |
| 9 | vencido | Vencido ‚ùå |

## üõ°Ô∏è Seguran√ßa

- ‚úÖ Tokens √∫nicos com 15min de expira√ß√£o
- ‚úÖ CORS configurado
- ‚úÖ Helmet para headers de seguran√ßa
- ‚úÖ Valida√ß√£o de dados de entrada
- ‚úÖ Error handling completo

## üöÄ Deploy

### Vercel
\`\`\`bash
vercel --prod
\`\`\`

### Railway
\`\`\`bash
railway login
railway deploy
\`\`\`

### Docker
\`\`\`dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
EXPOSE 3000
CMD ["npm", "start"]
\`\`\`

## üìù Logs

O sistema gera logs detalhados:

\`\`\`
üöÄ SuperPay Integration API iniciada!
üì° Servidor rodando na porta 3000
üõí Iniciando checkout: FRETE_1703123456789_abc123
üîÑ SuperPay Request: POST /v4/invoices
‚úÖ SuperPay Response: 200 /v4/invoices
‚úÖ Checkout criado com sucesso: FRETE_1703123456789_abc123
üîî Webhook recebido da SuperPay: {...}
üí∞ Pagamento confirmado: FRETE_1703123456789_abc123
\`\`\`

## ‚ö†Ô∏è Regras Importantes

1. **Nunca fazer polling** na API da SuperPay
2. **Sempre usar webhooks** para atualiza√ß√µes
3. **Consultar apenas Supabase** no endpoint de status
4. **Tokens expiram em 15 minutos**
5. **Sempre retornar sucesso** nos webhooks

## üÜò Troubleshooting

### Erro de conex√£o Supabase
- Verifique SUPABASE_URL e SUPABASE_KEY
- Execute o SQL de cria√ß√£o da tabela

### Erro na SuperPay
- Verifique SUPERPAY_TOKEN e SUPERPAY_SECRET
- Teste com `/health` endpoint

### Webhook n√£o funciona
- Configure WEBHOOK_BASE_URL corretamente
- Adicione a URL no painel da SuperPay

## üìû Suporte

Para d√∫vidas sobre a integra√ß√£o SuperPay, consulte a documenta√ß√£o oficial ou entre em contato com o suporte.
\`\`\`

```plaintext file="CREDENTIALS_GUIDE.md"
# üîê Guia Completo de Credenciais - SuperPay Integration

## üìç Onde Encontrar Cada Credencial

### üè¶ SuperPay Credentials

#### 1. SUPERPAY_TOKEN
- **Onde encontrar:** Painel SuperPay ‚Üí Configura√ß√µes ‚Üí API ‚Üí Tokens
- **Caminho:** https://painel.superpaybr.com ‚Üí Menu lateral ‚Üí "API" ‚Üí "Tokens"
- **Formato:** `sp_live_abc123...` ou `sp_test_abc123...`
- **Exemplo:** `sp_live_1234567890abcdef1234567890abcdef`

#### 2. SUPERPAY_SECRET
- **Onde encontrar:** Painel SuperPay ‚Üí Configura√ß√µes ‚Üí API ‚Üí Chaves Secretas
- **Caminho:** https://painel.superpaybr.com ‚Üí Menu lateral ‚Üí "API" ‚Üí "Webhooks"
- **Formato:** String aleat√≥ria de 32+ caracteres
- **Exemplo:** `sk_live_abcdef1234567890abcdef1234567890`

#### 3. SUPERPAY_BASE_URL
- **Valor fixo:** `https://api.superpaybr.com`
- **N√£o precisa alterar:** Esta √© a URL oficial da API v4

### üóÑÔ∏è Supabase Credentials

#### 1. SUPABASE_URL
- **Onde encontrar:** Dashboard Supabase ‚Üí Settings ‚Üí API ‚Üí Project URL
- **Caminho:** https://supabase.com/dashboard ‚Üí Seu projeto ‚Üí Settings ‚Üí API
- **Formato:** `https://[projeto-id].supabase.co`
- **Exemplo:** `https://abcdefghijklmnop.supabase.co`

#### 2. SUPABASE_KEY
- **Onde encontrar:** Dashboard Supabase ‚Üí Settings ‚Üí API ‚Üí service_role secret
- **Caminho:** https://supabase.com/dashboard ‚Üí Seu projeto ‚Üí Settings ‚Üí API
- **Tipo:** Use a chave `service_role` (n√£o a `anon public`)
- **Formato:** String longa come√ßando com `eyJ...`
- **Exemplo:** `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

### üîß Configura√ß√µes do Servidor

#### 1. PORT
- **Valor padr√£o:** `3000`
- **Descri√ß√£o:** Porta onde o servidor vai rodar
- **Exemplo:** `3000`, `8080`, `5000`

#### 2. ALLOWED_ORIGINS
- **Descri√ß√£o:** URLs permitidas para CORS
- **Formato:** URLs separadas por v√≠rgula
- **Exemplo:** `https://meusite.com,https://www.meusite.com`
- **Para desenvolvimento:** `*` (permite todas)

#### 3. WEBHOOK_BASE_URL
- **Descri√ß√£o:** URL base da sua API para webhooks
- **Formato:** URL completa sem barra final
- **Exemplo:** `https://minha-api.vercel.app`
- **Importante:** SuperPay vai chamar `${WEBHOOK_BASE_URL}/webhook/superpay`

#### 4. WEBHOOK_SECRET_KEY (Opcional)
- **Descri√ß√£o:** Chave para validar webhooks (opcional)
- **Formato:** String aleat√≥ria
- **Exemplo:** `minha-chave-secreta-webhook-123`

## üöÄ Passo a Passo Completo

### Passo 1: Criar Conta SuperPay
1. Acesse https://superpaybr.com
2. Crie sua conta
3. Fa√ßa login no painel: https://painel.superpaybr.com

### Passo 2: Obter Credenciais SuperPay
1. No painel, v√° em **API** ‚Üí **Tokens**
2. Copie seu `SUPERPAY_TOKEN`
3. V√° em **API** ‚Üí **Webhooks**
4. Copie sua `SUPERPAY_SECRET`

### Passo 3: Criar Projeto Supabase
1. Acesse https://supabase.com
2. Crie um novo projeto
3. Aguarde a cria√ß√£o (2-3 minutos)

### Passo 4: Obter Credenciais Supabase
1. No dashboard, v√° em **Settings** ‚Üí **API**
2. Copie a **Project URL** (`SUPABASE_URL`)
3. Copie a chave **service_role secret** (`SUPABASE_KEY`)

### Passo 5: Configurar .env
\`\`\`env
# SuperPay
SUPERPAY_TOKEN=sp_live_seu_token_aqui
SUPERPAY_SECRET=sk_live_sua_secret_aqui
SUPERPAY_BASE_URL=https://api.superpaybr.com

# Supabase
SUPABASE_URL=https://seu-projeto.supabase.co
SUPABASE_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Server
PORT=3000
ALLOWED_ORIGINS=https://seusite.com
WEBHOOK_BASE_URL=https://sua-api.vercel.app
\`\`\`

### Passo 6: Criar Tabela no Supabase
1. No Supabase, v√° em **SQL Editor**
2. Execute o conte√∫do de `scripts/create-payments-table.sql`
3. Clique em **Run** para criar a tabela

### Passo 7: Configurar Webhook na SuperPay
1. No painel SuperPay, v√° em **API** ‚Üí **Webhooks**
2. Adicione a URL: `https://sua-api.vercel.app/webhook/superpay`
3. Selecione os eventos de pagamento
4. Salve a configura√ß√£o

## ‚ö†Ô∏è Dicas Importantes

### Ambiente de Teste vs Produ√ß√£o
- **Teste:** Use tokens que come√ßam com `sp_test_`
- **Produ√ß√£o:** Use tokens que come√ßam com `sp_live_`

### Seguran√ßa
- ‚úÖ Nunca commite o arquivo `.env`
- ‚úÖ Use vari√°veis de ambiente no deploy
- ‚úÖ Mantenha as chaves secretas seguras
- ‚úÖ Use HTTPS em produ√ß√£o

### Troubleshooting Comum

#### Erro: "SUPERPAY_TOKEN n√£o est√° definida"
- Verifique se o arquivo `.env` existe
- Confirme se a vari√°vel est√° sem espa√ßos
- Reinicie o servidor ap√≥s alterar `.env`

#### Erro: "Conex√£o Supabase falhou"
- Verifique se a URL est√° correta
- Confirme se est√° usando a chave `service_role`
- Teste a conex√£o no painel do Supabase

#### Webhook n√£o funciona
- Confirme se a URL est√° acess√≠vel publicamente
- Verifique se n√£o h√° firewall bloqueando
- Teste com ferramentas como ngrok em desenvolvimento

## üìû Suporte

### SuperPay
- Documenta√ß√£o: https://docs.superpaybr.com
- Suporte: suporte@superpaybr.com

### Supabase
- Documenta√ß√£o: https://supabase.com/docs
- Comunidade: https://github.com/supabase/supabase/discussions

### Este Sistema
- Verifique os logs do servidor
- Use o endpoint `/health` para testar
- Consulte o README.md para mais detalhes
